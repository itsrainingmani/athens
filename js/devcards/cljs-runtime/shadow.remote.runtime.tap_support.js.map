{"version":3,"sources":["shadow/remote/runtime/tap_support.cljc"],"mappings":"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","names":["p__59933","p__59934","map__59935","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","map__59936","shadow.remote.runtime.tap-support/tap-subscribe","subs-ref","obj-support","runtime","svc","tid","summary","history","num","msg","cljs.core.swap_BANG_","cljs.core/assoc","shadow.remote.runtime.api/reply","shadow.remote.runtime.obj-support/get-tap-history","cljs.core.map","oid","shadow.remote.runtime.obj-support/obj-describe*","cljs.core.into","p__59939","p__59940","map__59941","map__59942","shadow.remote.runtime.tap-support/tap-unsubscribe","cljs.core/dissoc","p__59945","p__59946","map__59947","map__59948","shadow.remote.runtime.tap-support/request-tap-history","tap-ids","p__59951","map__59952","shadow.remote.runtime.tap-support/tool-disconnect","shadow.remote.runtime.tap-support/start","cljs.core.atom","tap-fn","obj","shadow.remote.runtime.obj-support/register","seq__59958","cljs.core/seq","cljs.core/deref","chunk__59959","count__59960","i__59961","vec__59968","cljs.core.nth","temp__5735__auto__","cljs.core/chunked-seq?","c__4556__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","vec__59971","cljs.core/first","cljs.core/next","tap-config","shadow.remote.runtime.api/relay-msg","p1__59954#","p1__59955#","p1__59956#","p1__59957#","shadow.remote.runtime.api/add-extension","cljs.core/add-tap","p__59974","map__59975","shadow.remote.runtime.tap-support/stop","cljs.core/remove-tap","shadow.remote.runtime.api/del-extension"],"sourcesContent":["(ns shadow.remote.runtime.tap-support\n  (:require\n    [shadow.remote.runtime.api :as p]\n    [shadow.remote.runtime.obj-support :as obj]))\n\n(defn tap-subscribe\n  [{:keys [subs-ref obj-support runtime] :as svc} {:keys [tid summary history num] :or {num 10} :as msg}]\n  (swap! subs-ref assoc tid msg)\n  ;; FIXME: should this always confirm?\n  ;; tool may want to do stuff even if it didn't request a history?\n  ;; but it can do so optimistically and just receive taps?\n\n  ;; we need an option to send out the history because of concurrency issues\n  ;; otherwise it may do a :request-tap-history before :tap-subscribe\n  ;; which may cause it to miss taps inbetween\n  ;; or after which means it may have received taps before receiving the history\n  (when history\n    (p/reply runtime msg\n      {:op :tap-subscribed\n       :history (->> (obj/get-tap-history obj-support num)\n                     ;; FIXME: only send summary if requested\n                     (map (fn [oid] {:oid oid :summary (obj/obj-describe* obj-support oid)}))\n                     (into []))})))\n\n(defn tap-unsubscribe\n  [{:keys [subs-ref]} {:keys [tid]}]\n  (swap! subs-ref dissoc tid))\n\n(defn request-tap-history\n  [{:keys [obj-support runtime]}\n   {:keys [num] :or {num 10} :as msg}]\n  (let [tap-ids (obj/get-tap-history obj-support num)]\n    (p/reply runtime msg {:op :tap-history\n                          :oids tap-ids})))\n\n(defn tool-disconnect\n  [{:keys [subs-ref] :as svc} tid]\n  (swap! subs-ref dissoc tid))\n\n(defn start [runtime obj-support]\n  (let [subs-ref\n        (atom {})\n\n        tap-fn\n        (fn runtime-tap [obj]\n          (when (some? obj)\n            (let [oid (obj/register obj-support obj {:from :tap})]\n              (doseq [[tid tap-config] @subs-ref]\n                (p/relay-msg runtime {:op :tap :tid tid :oid oid})))))\n\n        svc\n        {:runtime runtime\n         :obj-support obj-support\n         :tap-fn tap-fn\n         :subs-ref subs-ref}]\n\n    (p/add-extension runtime\n      ::ext\n      {:ops\n       ;; would be nicer to just pass tap-subscribe and have the runtime\n       ;; automatically pass extra args. but this makes everything REPL unfriendly\n       ;; and will require a runtime restart for every op change\n       ;; this way only adding ops requires a restart\n       {:tap-subscribe #(tap-subscribe svc %)\n        :tap-unsubscribe #(tap-unsubscribe svc %)\n        :request-tap-history #(request-tap-history svc %)}\n       :on-tool-disconnect #(tool-disconnect svc %)})\n\n    (add-tap tap-fn)\n    svc))\n\n(defn stop [{:keys [tap-fn runtime] :as svc}]\n  (remove-tap tap-fn)\n  (p/del-extension runtime ::ext))\n"]}