{"version":3,"sources":["athens/listeners.cljs"],"mappings":"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","names":["athens.listeners/multi-block-selection","e","cljs.core/deref","selected-items","G__56153","re-frame.core/subscribe","cljs.core/not-empty","shift","key-code","direction","athens.keybindings/arrow-key-direction","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","goog.events.KeyCodes/ENTER","G__56154","re-frame.core/dispatch","cljs.core/first","G__56155","goog.events.KeyCodes/BACKSPACE","G__56156","and__4174__auto__","G__56157","G__56158","G__56159","G__56160","G__56161","G__56162","cljs.core/last","athens.listeners/get-dataset-uid","el","block","uid","athens.listeners/multi-block-select-over","target","related-target","target-uid","_related-target-uid","G__56165","_set-items","cljs.core/set","G__56166","athens.listeners/multi-block-select-up","_","goog.events/unlisten","js/window","goog.events.EventType/MOUSEOVER","goog.events.EventType/MOUSEUP","athens.listeners/unfocus","G__56167","editing-uid","G__56168","closest-block","closest-block-header","closest-page-header","closest","or__4185__auto__","G__56169","G__56170","athens.listeners/mouse-down-outside-athena","athena?","G__56171","G__56172","athens.listeners/key-down","key","ctrl","meta","goog.events.KeyCodes/Z","G__56173","G__56174","goog.events.KeyCodes/K","G__56175","goog.events.KeyCodes/G","G__56176","goog.events.KeyCodes/R","G__56177","goog.events.KeyCodes/L","G__56178","athens.listeners/init","goog.events/listen","goog.events.EventType/MOUSEDOWN","goog.events.EventType/KEYDOWN"],"sourcesContent":["(ns athens.listeners\n  (:require\n    ;;[athens.util :refer [get-day]]\n    [athens.keybindings :refer [arrow-key-direction]]\n    [cljsjs.react]\n    [cljsjs.react.dom]\n    [goog.events :as events]\n    [re-frame.core :refer [dispatch subscribe]])\n  (:import\n    (goog.events\n      EventType\n      KeyCodes)))\n\n\n;; -- shift-up/down when multi-block selection ---------------------------\n\n;; can no longer use on-key-down from keybindings.cljs. textarea is no longer focused, so events must be handled globally\n(defn multi-block-selection\n  [e]\n  (let [selected-items @(subscribe [:selected/items])]\n    (when (not-empty selected-items)\n      (let [shift     (.. e -shiftKey)\n            key-code (.. e -keyCode)\n            direction (arrow-key-direction e)]\n        ;; what should tab/shift-tab do? roam and workflowy have slightly different behavior\n        (cond\n          (= key-code KeyCodes.ENTER) (do\n                                        (dispatch [:editing/uid (first selected-items)])\n                                        (dispatch [:selected/clear-items]))\n          (= key-code KeyCodes.BACKSPACE) (dispatch [:selected/delete selected-items])\n          (and shift (= direction :up)) (dispatch [:selected/up selected-items])\n          (and shift (= direction :down)) (dispatch [:selected/down selected-items])\n          (= direction :up) (do\n                              (.preventDefault e)\n                              (dispatch [:selected/clear-items])\n                              (dispatch [:up (first selected-items)]))\n          (= direction :down) (do\n                                (.preventDefault e)\n                                (dispatch [:selected/clear-items])\n                                (dispatch [:down (last selected-items)])))))))\n\n\n;; -- When dragging across multiple blocks to select ---------------------\n\n(defn get-dataset-uid\n  [el]\n  (let [block (when el (.. el (closest \".block-container\")))\n        uid (when block (.. block -dataset -uid))]\n    uid))\n\n\n(defn multi-block-select-over\n  \"If going over something, add it.\n  If leaving it, remove\"\n  [e]\n  (let [target             (.. e -target)\n        related-target     (.. e -relatedTarget)\n        target-uid         (get-dataset-uid target)\n        _related-target-uid (get-dataset-uid related-target)\n        selected-items     @(subscribe [:selected/items])\n        _set-items (set selected-items)]\n    (.. e stopPropagation)\n    (.. target blur)\n    (dispatch [:selected/add-item target-uid])))\n\n\n(defn multi-block-select-up\n  [_]\n  (events/unlisten js/window EventType.MOUSEOVER multi-block-select-over)\n  (events/unlisten js/window EventType.MOUSEUP multi-block-select-up))\n\n;; -- When user clicks elsewhere -----------------------------------------\n\n(defn unfocus\n  [e]\n  (let [selected-items @(subscribe [:selected/items])\n        editing-uid    @(subscribe [:editing/uid])\n        closest-block (.. e -target (closest \".block-content\"))\n        closest-block-header (.. e -target (closest \".block-header\"))\n        closest-page-header (.. e -target (closest \".page-header\"))\n        closest (or closest-block closest-block-header closest-page-header)]\n    (when (not-empty selected-items)\n      (dispatch [:selected/clear-items]))\n    (when (and (nil? closest) editing-uid)\n      (dispatch [:editing/uid nil]))))\n\n\n;; -- Turn read block or header into editable on mouse down --------------\n\n;; (defn edit-block\n;;   [e]\n;;   ;; Consider refactor if we add more editable targets\n;;   (let [closest-block (.. e -target (closest \".block-content\"))\n;;         closest-block-header (.. e -target (closest \".block-header\"))\n;;         closest-page-header (.. e -target (closest \".page-header\"))\n;;         closest (or closest-block closest-block-header closest-page-header)]\n;;     (when closest\n;;       (dispatch [:editing/uid (.. closest -dataset -uid)]))))\n\n\n;; -- Close Athena -------------------------------------------------------\n\n(defn mouse-down-outside-athena\n  [e]\n  (let [athena? @(subscribe [:athena/open])\n        closest (.. e -target (closest \".athena\"))]\n    (when (and athena? (nil? closest))\n      (dispatch [:athena/toggle]))))\n\n\n;; -- Hotkeys ------------------------------------------------------------\n\n\n(defn key-down\n  [e]\n  (let [key (.. e -keyCode)\n        ctrl (.. e -ctrlKey)\n        meta (.. e -metaKey)\n        shift (.. e -shiftKey)]\n\n    (cond\n      (and (= key KeyCodes.Z) meta shift)\n      (dispatch [:redo])\n\n      (and (= key KeyCodes.Z) meta)\n      (dispatch [:undo])\n\n      (and (= key KeyCodes.K) meta)\n      (dispatch [:athena/toggle])\n\n      (and (= key KeyCodes.G) ctrl)\n      (dispatch [:devtool/toggle])\n\n      (and (= key KeyCodes.R) ctrl)\n      (dispatch [:right-sidebar/toggle])\n\n      (and (= key KeyCodes.L) ctrl)\n      (dispatch [:left-sidebar/toggle]))))\n\n\n(defn init\n  []\n  ;; (events/listen js/window EventType.MOUSEDOWN edit-block)\n  (events/listen js/window EventType.MOUSEDOWN unfocus)\n  (events/listen js/window EventType.MOUSEDOWN mouse-down-outside-athena)\n  (events/listen js/window EventType.KEYDOWN multi-block-selection)\n  (events/listen js/window EventType.KEYDOWN key-down))\n\n"]}